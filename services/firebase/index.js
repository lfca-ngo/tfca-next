import { getApp, initializeApp } from 'firebase/app'
import {
  collection,
  doc,
  getDocs,
  getFirestore,
  query,
  serverTimestamp,
  setDoc,
  where,
} from 'firebase/firestore'

const REFERRALS_COLLECTION = 'referrals'

const safeGetObjectsCount = (object) => {
  if (typeof object !== object) return 0
  return Object.keys(object).length
}

const config = {
  apiKey: process.env.FB_API_KEY,
  appId: process.env.FB_APP_ID,
  authDomain: process.env.FB_AUTH_DOMAIN,
  messagingSenderId: process.env.FB_MESSAGING_SENDER_ID,
  projectId: process.env.FB_PROJECT_ID,
  storageBucket: process.env.FB_STORAGE_BUCKET,
}

function createFirebaseApp(config) {
  try {
    return getApp()
  } catch {
    return initializeApp(config)
  }
}

const app = createFirebaseApp(config)
export const firestore = getFirestore(app)

/**
 * Track accepted invites, when a user who came
 * via referral starts using the app
 */
export const trackAcceptedInvite = ({ invitedByUserId, userId }) => {
  return setDoc(
    doc(firestore, REFERRALS_COLLECTION, invitedByUserId),
    {
      acceptedInvites: {
        [`${userId}11`]: {
          createdAt: serverTimestamp(),
        },
      },
    },
    { merge: true }
  )
}

/**
 * Track invites that are generated by the current user
 * to invite others to the app
 */
export const trackInvite = ({
  invitedUserId,
  invitedUserName,
  shortLink,
  teamId,
  userId,
  userName,
}) => {
  // add to invites of this user
  return setDoc(
    doc(firestore, REFERRALS_COLLECTION, userId),
    {
      invites: {
        [`${invitedUserId}`]: {
          name: invitedUserName,
          shortLink: shortLink,
        },
      },
      name: userName,
      teamId: teamId || null,
      userId: userId,
    },
    { merge: true }
  )
}

/**
 * Read team scores to show on the leaderboard
 */
export const getTeamScores = async (teamId) => {
  try {
    const referralsRef = collection(firestore, REFERRALS_COLLECTION)
    const q = query(referralsRef, where('teamId', '==', teamId))
    const querySnapshot = await getDocs(q)
    const teamScores = []

    try {
      querySnapshot.forEach((doc) => {
        const data = doc.data()

        // count actions that this user triggered
        // through her referrals
        const triggeredActionsCount = data.acceptedInvites
          ? Object.keys(data.acceptedInvites).reduce((acc, key) => {
              const completedActionsCount = safeGetObjectsCount(
                data.acceptedInvites[key]?.completedActions
              )

              return acc + completedActionsCount
            }, 0)
          : 0

        teamScores.push({
          ...data,
          invitedUsersCount: Object.keys().length,
          triggeredActionsCount,
        })
      })
    } catch (error) {
      console.error('failed to aggregate team scores', error)
    }

    return teamScores
  } catch (error) {}
}

/**
 * Update the action counter for users that came
 * via referral
 */
export const updateActionCountOnReferredUsers = ({
  actionId,
  referredByUserId,
  userId,
}) => {
  // add to invites of this user
  return setDoc(
    doc(firestore, REFERRALS_COLLECTION, referredByUserId),
    {
      acceptedInvites: {
        [`${userId}`]: {
          completedActions: {
            [actionId]: serverTimestamp(),
          },
        },
      },
    },
    { merge: true }
  )
}
